<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Tips</h1>
</div>

<%
    function sortUrl(field) {
        const newOrder = (sort === field && order === -1) ? 'asc' : 'desc';
        let url = '?sort=' + field + '&order=' + newOrder;
        if (statusFilter) url += '&status=' + statusFilter;
        return url;
    }
    function sortIcon(field) {
        if (sort !== field) return '';
        return order === -1 ? ' &#9660;' : ' &#9650;';
    }
%>

<form method="GET" action="/tips" class="row g-2 align-items-end mb-3">
    <div class="col-auto">
        <label for="status" class="form-label mb-0">Filter by status:</label>
    </div>
    <div class="col-auto">
        <select name="status" id="status" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="" <%= statusFilter === '' ? 'selected' : '' %>>All</option>
            <option value="new" <%= statusFilter === 'new' ? 'selected' : '' %>>New</option>
            <option value="processed" <%= statusFilter === 'processed' ? 'selected' : '' %>>Processed</option>
            <option value="rejected" <%= statusFilter === 'rejected' ? 'selected' : '' %>>Rejected</option>
        </select>
    </div>
</form>

<% if (!tips || tips.length === 0) { %>
    <p class="text-center">No tips found.</p>
<% } else { %>
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th><a href="<%= sortUrl('dateAdded') %>" class="text-decoration-none text-dark">Date<%- sortIcon('dateAdded') %></a></th>
                    <th><a href="<%= sortUrl('status') %>" class="text-decoration-none text-dark">Status<%- sortIcon('status') %></a></th>
                    <th><a href="<%= sortUrl('url') %>" class="text-decoration-none text-dark">URL<%- sortIcon('url') %></a></th>
                    <th><a href="<%= sortUrl('message') %>" class="text-decoration-none text-dark">Message<%- sortIcon('message') %></a></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <% tips.forEach(tip => { %>
                    <tr>
                        <td><%= new Date(tip.dateAdded).toLocaleDateString() %></td>
                        <td>
                            <% if (tip.status === 'new') { %>
                                <span class="badge bg-primary">New</span>
                            <% } else if (tip.status === 'processed') { %>
                                <span class="badge bg-success">Processed</span>
                            <% } else if (tip.status === 'rejected') { %>
                                <span class="badge bg-danger">Rejected</span>
                            <% } %>
                        </td>
                        <td>
                            <a href="<%= tip.url %>" target="_blank" rel="noopener noreferrer">
                                <%= tip.url.length > 50 ? tip.url.substring(0, 50) + '...' : tip.url %>
                            </a>
                        </td>
                        <td><%= tip.message.length > 100 ? tip.message.substring(0, 100) + '...' : tip.message %></td>
                        <td>
                            <a href="/tips/<%= tip._id %>" class="btn btn-sm btn-outline-secondary">Details</a>
                            <form method="POST" action="/tips/<%= tip._id %>/delete" class="d-inline"
                                onsubmit="return confirm('Are you sure you want to delete this tip?')">
                                <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                            </form>
                        </td>
                    </tr>
                <% }) %>
            </tbody>
        </table>
    </div>
<% } %>
